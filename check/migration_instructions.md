# دليل نقل البيانات من قاعدة البيانات القديمة

## نظرة عامة
هذا الدليل يوضح كيفية نقل البيانات من جدول `lawegs` في قاعدة البيانات القديمة إلى الجداول الجديدة في المشروع الحالي.

## هيكل البيانات

### قاعدة البيانات القديمة
- **جدول واحد**: `lawegs`
- **الحقول المهمة**:
  - `title_ar` - العنوان
  - `description_ar` - المحتوى
  - `laweg_number` - رقم القانون
  - `laweg_release_date` - تاريخ القانون
  - `laweg_subject` - التصنيف وفقًا للحق
  - `laweg_issuer_pub` - جهة الإصدار
  - `laweg_type` - حالة القانون

### قاعدة البيانات الجديدة
- **جدول الوثائق**: `documents`
- **جدول المستخدمين**: `users`
- **جدول الحقول المخصصة**: `document_custom_fields`
- **جدول قيم الحقول**: `document_field_values`

## ربط الحقول

| الحقل القديم | الحقل الجديد | نوع الحقل | ID الحقل |
|--------------|-------------|-----------|----------|
| `laweg_number` | `law_number` | text | 9 |
| `laweg_release_date` | `law_date` | date | 2 |
| `laweg_subject` | `law_subject` | select | 10 |
| `laweg_issuer_pub` | `law_issuer_pub` | select | 3 |
| `laweg_type` | `law_type` | select | 6 |

## خطوات النقل

### 1. إعداد قاعدة البيانات القديمة
```php
// في ملف migrate_old_data.php، قم بتعديل هذه الإعدادات:
$oldDbConfig = [
    'host' => 'localhost',
    'database' => 'اسم_قاعدة_البيانات_القديمة', // ضع الاسم الصحيح هنا
    'username' => 'root',
    'password' => 'كلمة_المرور', // ضع كلمة المرور إذا كانت موجودة
    'charset' => 'utf8mb4',
    'collation' => 'utf8mb4_unicode_ci',
];
```

### 2. التحقق من المتطلبات
- تأكد من وجود المستخدم رقم 1 في جدول `users`
- تأكد من وجود قسم القوانين (slug: `koanyn`)
- تأكد من وجود الحقول المخصصة المطلوبة

### 3. تشغيل السكريبت
```bash
php migrate_old_data.php
```

### 4. مراجعة النتائج
بعد تشغيل السكريبت، ستحصل على تقرير يوضح:
- عدد السجلات المنقولة بنجاح
- عدد السجلات التي فشل نقلها
- تفاصيل الأخطاء إن وجدت

## مثال على البيانات المنقولة

### السجل القديم
```sql
INSERT INTO `lawegs` VALUES (
    1716, 
    'قانون-رقم-1-لسنة-1990-بتاريخ-01011990', 
    NULL, 
    'قانون رقم 1 لسنة 1990 بتاريخ 01-01-1990', 
    NULL, 
    '1', 
    '1990-01-01', 
    'رئيس الجمهورية', 
    'حقوق اجتماعية وثقافية', 
    NULL, 
    'ساري', 
    NULL, 
    NULL, 
    NULL, 
    NULL, 
    'المحتوى المحتوى المحتوى', 
    NULL, 
    NULL, 
    NULL, 
    0, 0, 0, 
    'published', 
    NULL, 
    NULL, 
    '2025-02-19 14:59:44'
);
```

### البيانات الجديدة

#### جدول `documents`
```sql
INSERT INTO documents (
    section_id, user_id, title, content, slug, 
    is_published, views_count, downloads_count, shares_count,
    published_at, created_at, updated_at
) VALUES (
    1, -- قسم القوانين
    1, -- المستخدم الافتراضي
    'قانون رقم 1 لسنة 1990 بتاريخ 01-01-1990',
    'المحتوى المحتوى المحتوى',
    'قانون-رقم-1-لسنة-1990-بتاريخ-01011990',
    1, 0, 0, 0,
    '2025-02-19 14:59:44',
    '2025-02-19 14:59:44',
    '2025-02-19 14:59:44'
);
```

#### جدول `document_field_values`
```sql
-- رقم القانون
INSERT INTO document_field_values (document_id, field_id, value) 
VALUES (NEW_DOCUMENT_ID, 9, '1');

-- تاريخ القانون
INSERT INTO document_field_values (document_id, field_id, value) 
VALUES (NEW_DOCUMENT_ID, 2, '1990-01-01');

-- جهة الإصدار
INSERT INTO document_field_values (document_id, field_id, value) 
VALUES (NEW_DOCUMENT_ID, 3, 'رئيس الجمهورية');

-- التصنيف وفقًا للحق
INSERT INTO document_field_values (document_id, field_id, value) 
VALUES (NEW_DOCUMENT_ID, 10, 'حقوق اجتماعية وثقافية');

-- حالة القانون
INSERT INTO document_field_values (document_id, field_id, value) 
VALUES (NEW_DOCUMENT_ID, 6, 'ساري');
```

## نصائح مهمة

### 1. النسخ الاحتياطي
- قم بعمل نسخة احتياطية من قاعدة البيانات الجديدة قبل النقل
- احتفظ بنسخة من قاعدة البيانات القديمة

### 2. اختبار النقل
- اختبر السكريبت على عينة صغيرة من البيانات أولاً
- تأكد من صحة الحقول المخصصة والخيارات المتاحة

### 3. التحقق من النتائج
- راجع البيانات المنقولة في لوحة التحكم
- تأكد من صحة التواريخ والحقول النصية
- اختبر البحث والفلترة بعد النقل

### 4. معالجة الأخطاء
- إذا فشل نقل بعض السجلات، راجع رسائل الخطأ
- تأكد من توافق قيم الحقول مع الخيارات المحددة
- تحقق من صحة التواريخ والأرقام

## استكشاف الأخطاء

### خطأ الاتصال بقاعدة البيانات
```
❌ خطأ في الاتصال بقاعدة البيانات القديمة
```
**الحل**: تحقق من إعدادات قاعدة البيانات في السكريبت

### عدم وجود قسم القوانين
```
❌ لم يتم العثور على قسم القوانين
```
**الحل**: تأكد من وجود قسم بـ slug = 'koanyn'

### عدم وجود المستخدم الافتراضي
```
❌ لم يتم العثور على المستخدم رقم 1
```
**الحل**: أنشئ مستخدم بـ ID = 1 أو عدّل السكريبت لاستخدام مستخدم آخر

### خطأ في قيم الحقول المخصصة
```
❌ خطأ في نقل السجل: قيمة غير صحيحة للحقل
```
**الحل**: تحقق من توافق القيم مع نوع الحقل والخيارات المتاحة

## بعد النقل

1. **احذف ملفات النقل**:
   ```bash
   rm migrate_old_data.php
   rm check_laws_fields.php
   rm migration_instructions.md
   ```

2. **اختبر الوظائف**:
   - البحث في الوثائق
   - الفلترة بالحقول المخصصة
   - عرض تفاصيل الوثائق

3. **راجع الإحصائيات**:
   - عدد الوثائق في قسم القوانين
   - توزيع القيم في الحقول المخصصة
   - صحة الروابط والصور

## دعم إضافي

إذا واجهت أي مشاكل أثناء النقل:
1. راجع رسائل الخطأ في السكريبت
2. تحقق من سجلات قاعدة البيانات
3. اختبر الاتصال بقاعدة البيانات القديمة يدوياً
4. تأكد من صحة أسماء الجداول والحقول