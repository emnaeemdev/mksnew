<?php

// app/Services/GoogleSheetService.php

namespace App\Services;

use Google_Client;
use Google_Service_Sheets;
use Google_Service_Exception;

class GoogleSheetService
{
    protected $client;
    protected $service;

    public function __construct()
    {
        $this->client = new Google_Client();
        $this->client->setApplicationName('Your Application Name');
        $this->client->setScopes(Google_Service_Sheets::SPREADSHEETS_READONLY);
        $this->client->setAuthConfig(storage_path('credentials.json')); // مسار ملف الاعتماد
        $this->client->setAccessType('offline');

        $this->service = new Google_Service_Sheets($this->client);

    }

    // هذا هو الكود الذي قمت بإضافته
public function extractSpreadsheetId($url, $defaultId = null)
{
    // التعبير المنتظم لاستخراج الـ spreadsheetId من الرابط
    $pattern = '/(?:\/d\/|spreadsheets\/d\/)([a-zA-Z0-9_-]{28,})(?:\/|$|\?)/';

    // استخدام التعبير المنتظم لاستخراج الـ spreadsheetId
    if (preg_match($pattern, $url, $matches)) {
        return $matches[1];  // إعادة الـ spreadsheetId المستخرج من الرابط
    }

    // إذا فشل استخراج الـ spreadsheetId، نستخدم الـ defaultId
    if ($defaultId) {
        return $defaultId;  // إرجاع الـ spreadsheetId المدخل يدويًا
    }

    return null;  // إذا لم يتم استخراج الـ spreadsheetId
}


   public function getSheetData($spreadsheetId, $sheetName)
{
    try {
        // تحديد النطاق الذي تريد جلب البيانات منه (هنا نستخدم كامل الشيت)
        $range = $sheetName . '!A2:H200'; // يمكنك تعديل النطاق حسب احتياجك (مثلاً A1:Z للحصول على جميع الأعمدة من A إلى Z)

        $response = $this->service->spreadsheets_values->get($spreadsheetId, $range);
        return $response->getValues(); // جلب البيانات من الشيت
    } catch (Google_Service_Exception $e) {
        // إذا حدث خطأ، يتم تسجيله في السجلات
        \Log::error('Error fetching Google Sheets data: ' . $e->getMessage());
        return [];  // إرجاع مصفوفة فارغة في حال حدوث خطأ
    }
}


	public function getAllSheetNames($spreadsheetId)
{
    try {
        // الحصول على تفاصيل جوجل شيت
        $spreadsheet = $this->service->spreadsheets->get($spreadsheetId);

        // استخراج أسماء الأوراق من الملف
        $sheetNames = [];
        foreach ($spreadsheet->getSheets() as $sheet) {
            $sheetNames[] = $sheet->getProperties()->getTitle(); // جلب اسم الورقة
        }

        return $sheetNames;  // إرجاع أسماء الأوراق
    } catch (Google_Service_Exception $e) {
        \Log::error('Error fetching Google Sheets data: ' . $e->getMessage());
        return [];  // إرجاع مصفوفة فارغة في حال حدوث خطأ
    }
}



}
